import {
  BirdCollisionConfigType,
  WindfarmCollisionConfigType,
  WindfarmInstanceConfigType,
} from "../../services/vulnerability/types";
import { CommonConfig } from "../../analytics_config_types";
import { flightHeightTransitRisk } from "./flight-height-transit-risk";
import type { FlightHeightTransitRiskResponse } from "./flight-height-transit-risk";
import { Polygon } from "@turf/helpers";
import * as path from "path";

export interface MultipleAreaVulnerabilityRequest extends CommonConfig {
  areas: {
    id: number | string;
    area: GeoJSON.Feature<Polygon>;
    flightheights: [number, number][];
  }[];
  updownProportion: number;
  windfarmConfig: WindfarmCollisionConfigType;
  birdConfig: BirdCollisionConfigType;
  windfarmInstanceConfig: WindfarmInstanceConfigType;
  xinc: number;
  yinc: number;
}

export const multipleAreaVulnerabilityController = async ({
  areas,
  birdConfig,
  outputs,
  updownProportion,
  windfarmConfig,
  windfarmInstanceConfig,
  xinc,
  yinc,
}: MultipleAreaVulnerabilityRequest) => {
  if (!outputs) return;
  let result: { [p: string]: FlightHeightTransitRiskResponse } = {};
  for (let { area, flightheights, id } of areas) {
    const areaRes = await flightHeightTransitRisk({
      birdConfig,
      outputs: path.join(outputs, String(id)),
      updownProportion,
      windfarmConfig,
      windfarmInstanceConfig,
      xinc,
      yinc,
      area,
      flightheights,
    });
    result[id] = areaRes;
  }
  return result;
};
